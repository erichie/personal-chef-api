# User Profile API - `/api/me`

## Overview

The `/api/me` endpoint allows users to retrieve and update their own profile information.

---

## Get Current User Data

### Endpoint

```
GET /api/me
```

### Authentication

Requires Bearer token in the `Authorization` header.

### Sample Request

```bash
curl -X GET http://localhost:3000/api/me \
  -H "Authorization: Bearer YOUR_TOKEN"
```

### Sample Response

```json
{
  "user": {
    "id": "834115dd-9a14-40ed-8345-6cd8e8b2e8a8",
    "email": "user@example.com",
    "displayName": "John Doe",
    "friendCode": "NXXMQSFU",
    "bio": "Love cooking healthy meals!",
    "avatarUrl": "https://example.com/avatar.jpg",
    "isGuest": false,
    "createdAt": "2025-10-26T12:00:00.000Z",
    "updatedAt": "2025-10-26T12:00:00.000Z",
    "hasCompletedIntake": true,
    "lastSyncedAt": "2025-10-26T12:00:00.000Z",
    "syncVersion": 5
  }
}
```

### Response Fields

| Field                | Type           | Description                                 |
| -------------------- | -------------- | ------------------------------------------- |
| `id`                 | string         | Unique user identifier                      |
| `email`              | string \| null | User's email address (null for guests)      |
| `displayName`        | string \| null | User's display name                         |
| `friendCode`         | string \| null | 8-character friend code for social features |
| `bio`                | string \| null | User's bio/description                      |
| `avatarUrl`          | string \| null | URL to user's profile picture               |
| `isGuest`            | boolean        | Whether the user is a guest or registered   |
| `createdAt`          | string         | ISO 8601 timestamp of account creation      |
| `updatedAt`          | string         | ISO 8601 timestamp of last update           |
| `hasCompletedIntake` | boolean        | Whether user completed chef intake form     |
| `lastSyncedAt`       | string \| null | Last sync timestamp                         |
| `syncVersion`        | number         | Current sync version number                 |

### Error Responses

#### 401 Unauthorized

```json
{
  "error": "Unauthorized",
  "code": "UNAUTHORIZED"
}
```

#### 404 Not Found

```json
{
  "error": "User not found"
}
```

---

## Update User Profile

### Endpoint

```
PATCH /api/me
```

### Authentication

Requires Bearer token in the `Authorization` header.

### Request Body

All fields are optional - only include the fields you want to update:

```json
{
  "displayName": "Jane Doe",
  "bio": "Passionate about healthy cooking",
  "avatarUrl": "https://example.com/new-avatar.jpg"
}
```

### Updatable Fields

| Field         | Type           | Max Length | Notes                        |
| ------------- | -------------- | ---------- | ---------------------------- |
| `displayName` | string \| null | -          | Your public display name     |
| `bio`         | string \| null | -          | Your profile bio/description |
| `avatarUrl`   | string \| null | -          | URL to your profile picture  |

### Non-Updatable Fields

The following fields **cannot** be updated via this endpoint:

- `email` - Managed by authentication system
- `friendCode` - Generated by system, permanent
- `isGuest` - Determined by account type
- `id` - Immutable unique identifier

### Sample Request

```bash
curl -X PATCH http://localhost:3000/api/me \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "displayName": "Jane Doe",
    "bio": "Passionate about healthy cooking"
  }'
```

### Sample Response

```json
{
  "user": {
    "id": "834115dd-9a14-40ed-8345-6cd8e8b2e8a8",
    "email": "user@example.com",
    "displayName": "Jane Doe",
    "friendCode": "NXXMQSFU",
    "bio": "Passionate about healthy cooking",
    "avatarUrl": "https://example.com/avatar.jpg",
    "isGuest": false,
    "createdAt": "2025-10-26T12:00:00.000Z",
    "updatedAt": "2025-10-26T15:30:00.000Z"
  }
}
```

### Error Responses

#### 401 Unauthorized

```json
{
  "error": "Unauthorized",
  "code": "UNAUTHORIZED"
}
```

#### 400 Bad Request

```json
{
  "error": "Validation failed",
  "code": "VALIDATION_ERROR"
}
```

---

## Friend Code Information

Your **friend code** is an 8-character alphanumeric code used to connect with friends:

- **Format**: 8 uppercase letters and numbers (e.g., `NXXMQSFU`)
- **Display Format**: Can be shown with a dash for readability (e.g., `NXXM-QSFU`)
- **Unique**: Each user has a unique friend code
- **Permanent**: Cannot be changed once generated
- **Usage**: Share this code with friends so they can find and add you

### Getting Your Friend Code

Use the `GET /api/me` endpoint to retrieve your friend code:

```bash
curl -X GET http://localhost:3000/api/me \
  -H "Authorization: Bearer YOUR_TOKEN"
```

The response includes your `friendCode` field.

---

## Usage Examples

### TypeScript/JavaScript

#### Get Current User

```typescript
async function getCurrentUser() {
  const response = await fetch("http://localhost:3000/api/me", {
    headers: {
      Authorization: `Bearer ${token}`,
    },
  });

  const data = await response.json();
  return data.user;
}
```

#### Update Profile

```typescript
async function updateProfile(updates: {
  displayName?: string;
  bio?: string;
  avatarUrl?: string;
}) {
  const response = await fetch("http://localhost:3000/api/me", {
    method: "PATCH",
    headers: {
      Authorization: `Bearer ${token}`,
      "Content-Type": "application/json",
    },
    body: JSON.stringify(updates),
  });

  const data = await response.json();
  return data.user;
}

// Example usage
await updateProfile({
  displayName: "Jane Doe",
  bio: "Love cooking!",
});
```

### Swift (iOS)

#### Get Current User

```swift
func getCurrentUser() async throws -> User {
    let url = URL(string: "http://localhost:3000/api/me")!
    var request = URLRequest(url: url)
    request.setValue("Bearer \(token)", forHTTPHeaderField: "Authorization")

    let (data, _) = try await URLSession.shared.data(for: request)
    let response = try JSONDecoder().decode(UserResponse.self, from: data)
    return response.user
}
```

#### Update Profile

```swift
func updateProfile(displayName: String?, bio: String?, avatarUrl: String?) async throws -> User {
    let url = URL(string: "http://localhost:3000/api/me")!
    var request = URLRequest(url: url)
    request.httpMethod = "PATCH"
    request.setValue("Bearer \(token)", forHTTPHeaderField: "Authorization")
    request.setValue("application/json", forHTTPHeaderField: "Content-Type")

    var updates: [String: Any?] = [:]
    if let displayName = displayName { updates["displayName"] = displayName }
    if let bio = bio { updates["bio"] = bio }
    if let avatarUrl = avatarUrl { updates["avatarUrl"] = avatarUrl }

    request.httpBody = try JSONSerialization.data(withJSONObject: updates)

    let (data, _) = try await URLSession.shared.data(for: request)
    let response = try JSONDecoder().decode(UserResponse.self, from: data)
    return response.user
}
```

---

## Notes

- Both endpoints require authentication (Bearer token or X-Device-ID)
- Guest users (authenticated via device ID) can also use these endpoints
- The `friendCode` field may be `null` for very old users who haven't been migrated
- Timestamps are returned in ISO 8601 format (UTC)
- The `updatedAt` timestamp reflects the last time the user record was modified

---

## Related Endpoints

- `GET /api/friends` - List your friends
- `POST /api/friends/find-by-code` - Find a user by their friend code
- `GET /api/sync` - Get full user backup including profile data
- `POST /api/sync` - Sync profile data from device

---

**Status:** âœ… Production Ready  
**Last Updated:** October 26, 2025
